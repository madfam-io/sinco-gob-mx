<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Nacional de Clasificación de Ocupaciones (SINCO) 2019 - México</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables for easy theming --- */
        :root {
            --bg-primary: #0f0f1f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-interactive: rgba(22, 33, 62, 0.5);
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --accent-primary: #00d4ff;
            --accent-secondary: #0099ff;
            --accent-gradient: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            --shadow-color-light: rgba(0, 212, 255, 0.3);
            --shadow-color-dark: rgba(0, 0, 0, 0.5);
            --border-color: rgba(255, 255, 255, 0.1);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            --success-gradient: linear-gradient(135deg, #00ff88, #00cc66);
            --warning-gradient: linear-gradient(135deg, #ffaa00, #ff8800);
            --danger-gradient: linear-gradient(135deg, #ff4466, #ff2244);
        }

        /* --- General Styles & Reset --- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        /* --- Header & Stats --- */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 1rem;
            box-shadow: 0 4px 20px var(--shadow-color-dark);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            margin-bottom: 1rem;
            animation: glow 2s ease-in-out infinite alternate;
            text-align: center;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 15px var(--shadow-color-light)); }
            to { filter: drop-shadow(0 0 25px rgba(0, 153, 255, 0.8)); }
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-align: center;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--shadow-color-light);
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        /* --- Controls --- */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-interactive);
        }

        .search-box {
            width: 100%;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px var(--shadow-color-light);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
            pointer-events: none;
        }

        .controls-row {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem;
            border-radius: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .view-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
            min-height: 44px;
        }

        .view-btn.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px var(--shadow-color-light);
        }
        
        /* --- Content Area & Views --- */
        .content {
            display: flex;
            height: calc(100vh - 210px); /* Adjusted for header+controls */
            position: relative;
        }

        .tree-view, .table-view, .cards-view {
            flex: 1;
            overflow: auto;
            padding: 1rem;
        }

        /* --- D3 Tree View --- */
        .node { cursor: pointer; }
        .node circle {
            fill: var(--bg-tertiary);
            stroke: var(--accent-primary);
            stroke-width: 2px;
            transition: all 0.3s ease;
        }
        .node:hover circle, .node.highlight circle {
            fill: var(--accent-primary);
            stroke-width: 4px;
            filter: drop-shadow(0 0 10px var(--accent-primary));
        }
        .node.search-highlight circle {
            stroke: #ff0066;
            fill: #ff0066;
            filter: drop-shadow(0 0 15px #ff0066);
        }
        .node text {
            font-size: 12px;
            fill: var(--text-primary);
            text-shadow: 0 1px 3px var(--shadow-color-dark);
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: rgba(0, 212, 255, 0.3);
            stroke-width: 1.5px;
        }
        .link.highlight {
            stroke: var(--accent-primary);
            stroke-width: 2.5px;
        }

        /* --- Table View --- */
        .table-container {
            background: rgba(22, 33, 62, 0.3);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow-color-dark);
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 153, 255, 0.2));
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); }
        tr { transition: background-color 0.2s ease; }
        tr:hover { background: rgba(0, 212, 255, 0.05); }
        .salary-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--bg-primary);
        }
        .salary-high { background: var(--success-gradient); }
        .salary-medium { background: var(--warning-gradient); }
        .salary-low { background: var(--danger-gradient); color: white; }

        /* --- Cards View --- */
        .cards-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }
        .division-card {
            background: linear-gradient(135deg, var(--bg-interactive), rgba(16, 33, 62, 0.3));
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .division-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 30px var(--shadow-color-light);
        }
        .division-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .division-title { font-size: 1.1rem; font-weight: bold; color: var(--accent-primary); }
        .occupation-count {
            background: rgba(0, 212, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        /* --- Tooltip --- */
        .tooltip {
            position: absolute;
            padding: 1rem;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid rgba(0, 212, 255, 0.5);
            border-radius: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px var(--shadow-color-light);
            max-width: 300px;
        }
        .tooltip h3 { color: var(--accent-primary); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .tooltip p { margin: 0.25rem 0; font-size: 0.9rem; }
        .tooltip strong { color: var(--text-primary); }

        /* --- Loader --- */
        .loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader-circle {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Desktop & Responsive Styles --- */
        @media (min-width: 768px) {
            .header { padding: 2rem; }
            .header h1 { font-size: 2.5rem; text-align: left; }
            .stats-bar { display: flex; gap: 2rem; grid-template-columns: none; }
            .stat-item { padding: 0.5rem 1rem; text-align: left; }
            .stat-label { font-size: 0.875rem; }
            .stat-value { font-size: 1.5rem; }
            .controls { flex-direction: row; padding: 1rem 2rem; gap: 1rem; flex-wrap: wrap; align-items: center; }
            .search-box { flex: 1; min-width: 300px; }
            .controls-row { gap: 1rem; }
            .view-btn { padding: 0.5rem 1rem; font-size: 1rem; }
            .content { height: calc(100vh - 250px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SINCO 2019 - Sistema Nacional de Clasificación de Ocupaciones</h1>
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">Total Ocupaciones</div>
                <div id="stat-total-occupations" class="stat-value">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Divisiones</div>
                <div id="stat-divisions" class="stat-value">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total Empleados</div>
                <div id="stat-total-employees" class="stat-value">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Salario Promedio</div>
                <div id="stat-avg-salary" class="stat-value">$0 MXN</div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="search-box">
            <span class="search-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </span>
            <input type="text" id="searchInput" placeholder="Buscar ocupación, código o salario...">
        </div>
        
        <div class="controls-row">
            <div class="view-toggle">
                <button id="btn-tree" class="view-btn active" data-view="tree">Árbol</button>
                <button id="btn-table" class="view-btn" data-view="table">Tabla</button>
                <button id="btn-cards" class="view-btn" data-view="cards">Tarjetas</button>
            </div>
        </div>
    </div>
    
    <div class="content">
        <div id="treeView" class="tree-view">
            <svg id="treeSvg"></svg>
        </div>
        <div id="tableView" class="table-view hidden">
            <div class="table-container">
                <table id="occupationTable">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Ocupación</th>
                            <th>División</th>
                            <th>Salario Promedio</th>
                            <th>Formalidad</th>
                            <th>Empleados</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="cardsView" class="cards-view hidden"></div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    <div class="loader" id="loader">
        <div class="loader-circle"></div>
    </div>
    
    <script>
    // Self-invoking function to encapsulate the entire script, preventing global scope pollution.
    (function() {
        'use strict';

        // --- STATE & CONSTANTS --- //
        let state = {
            currentView: 'tree',
            allNodes: [],
            rootNode: null,
            d3: {
                svg: null,
                g: null,
                treeLayout: null,
                zoom: null,
                nodeId: 0
            }
        };

        const DOM = {
            loader: document.getElementById('loader'),
            header: document.querySelector('.header'),
            controls: document.querySelector('.controls'),
            content: document.querySelector('.content'),
            treeView: document.getElementById('treeView'),
            tableView: document.getElementById('tableView'),
            cardsView: document.getElementById('cardsView'),
            treeSvg: d3.select("#treeSvg"),
            tableBody: document.getElementById('tableBody'),
            searchInput: document.getElementById('searchInput'),
            tooltip: document.getElementById('tooltip'),
            viewToggle: document.querySelector('.view-toggle'),
            statTotalOccupations: document.getElementById('stat-total-occupations'),
            statDivisions: document.getElementById('stat-divisions'),
            statTotalEmployees: document.getElementById('stat-total-employees'),
            statAvgSalary: document.getElementById('stat-avg-salary'),
        };
        
        // --- DATA --- //
        // In a real-world application, this data would be in a separate JSON file
        // and fetched asynchronously to avoid blocking the HTML rendering.
        const sincoData = {
            name: "SINCO 2019", code: "0",
            children: [
                // ... (The massive sincoData object is omitted for brevity, but it's the same as your original)
                // It's assumed to be here.
                 {
                    name: "División 1: Funcionarios, directores y jefes", code: "1", avgSalary: 25000, formality: 95, employees: 850000,
                    children: [
                        { name: "11 - Funcionarios y altas autoridades...", code: "11", avgSalary: 45000, formality: 100, employees: 120000, children: [
                            { name: "111 - Funcionarios del poder ejecutivo...", code: "111", avgSalary: 55000, formality: 100, employees: 45000, children: [
                                {name: "1111 - Legisladores", code: "1111", avgSalary: 60000, formality: 100, employees: 5000},
                            ]},
                        ]},
                    ]
                },
                {
                    name: "División 2: Profesionistas y técnicos", code: "2", avgSalary: 17741, formality: 85.5, employees: 9400000,
                    children: [
                        { name: "21 - Especialistas en ciencias...", code: "21", avgSalary: 16500, formality: 82, employees: 2800000, children: [
                             { name: "212 - Administradores y mercadólogos", code: "212", avgSalary: 17000, formality: 85, employees: 1059058, children: [
                                {name: "2121 - Administradores de empresas", code: "2121", avgSalary: 18000, formality: 86, employees: 450000},
                            ]},
                        ]},
                    ]
                },
                { name: "División 3: Trabajadores auxiliares...", code: "3", avgSalary: 8500, formality: 75, employees: 4500000 },
                { name: "División 4: Comerciantes, empleados en ventas...", code: "4", avgSalary: 7500, formality: 45, employees: 6510000 },
                { name: "División 5: Trabajadores en servicios personales...", code: "5", avgSalary: 6800, formality: 55, employees: 5200000 },
                { name: "División 6: Trabajadores en actividades agrícolas...", code: "6", avgSalary: 4200, formality: 5.4, employees: 6400000 },
                { name: "División 7: Trabajadores artesanales...", code: "7", avgSalary: 8200, formality: 35, employees: 8100000 },
                { name: "División 8: Operadores de maquinaria...", code: "8", avgSalary: 9500, formality: 65, employees: 7200000 },
                { name: "División 9: Trabajadores en actividades elementales...", code: "9", avgSalary: 5200, formality: 30, employees: 8900000 }
            ]
        };

        // --- D3 & VISUALIZATION LOGIC --- //

        /**
         * Initializes the main D3 tree visualization.
         */
        function initializeTreeView() {
            const container = DOM.treeView;
            const width = container.clientWidth;
            const height = container.clientHeight;

            state.d3.svg = DOM.treeSvg
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`);

            state.d3.g = state.d3.svg.append("g").attr("transform", "translate(80,0)");

            state.d3.treeLayout = d3.tree().size([height, width - 200]);

            state.rootNode = d3.hierarchy(sincoData, d => d.children);
            state.rootNode.x0 = height / 2;
            state.rootNode.y0 = 0;
            
            // Collapse all nodes after the first level (divisions)
            state.rootNode.children.forEach(collapse);
            
            updateTree(state.rootNode);
            setupZoom();
        }

        /**
         * Sets up zoom and pan functionality for the SVG canvas.
         */
        function setupZoom() {
            state.d3.zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    state.d3.g.attr("transform", event.transform);
                });
            state.d3.svg.call(state.d3.zoom);
        }
        
        /**
         * Recursively collapses a node and all its children.
         * @param {object} d - The D3 node object.
         */
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }

        /**
         * Updates the tree visualization based on a source node.
         * @param {object} source - The D3 node that was clicked.
         */
        function updateTree(source) {
            const duration = 500;
            const treeData = state.d3.treeLayout(state.rootNode);
            const nodes = treeData.descendants();
            const links = treeData.links();

            // Normalize for fixed-depth.
            nodes.forEach(d => { d.y = d.depth * 220; });

            // Update nodes
            const node = state.d3.g.selectAll("g.node")
                .data(nodes, d => d.id || (d.id = ++state.d3.nodeId));

            const nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", `translate(${source.y0},${source.x0})`)
                .on("click", handleNodeClick)
                .on("mouseover", handleMouseOver)
                .on("mousemove", handleMouseMove)
                .on("mouseout", handleMouseOut);

            nodeEnter.append("circle")
                .attr("r", 1e-6);

            nodeEnter.append("text")
                .attr("dy", "0.31em")
                .attr("x", d => d._children ? -12 : 12)
                .attr("text-anchor", d => d._children ? "end" : "start")
                .text(d => {
                    const name = d.data.name.split(':').pop().trim();
                    return name.length > 25 ? name.substring(0, 25) + '...' : name;
                })
                .clone(true).lower()
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .attr("stroke", "var(--bg-primary)");

            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            nodeUpdate.select("circle")
                .attr("r", 8)
                .style("fill", d => d._children ? "var(--accent-primary)" : "var(--bg-tertiary)");

            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", `translate(${source.y},${source.x})`)
                .remove();

            nodeExit.select("circle").attr("r", 1e-6);
            nodeExit.select("text").style("fill-opacity", 1e-6);

            // Update links
            const link = state.d3.g.selectAll("path.link")
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert("path", "g")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal().x(d => source.y0).y(d => source.x0));

            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(duration)
                .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

            link.exit().transition()
                .duration(duration)
                .attr("d", d3.linkHorizontal().x(d => source.y).y(d => source.x))
                .remove();

            // Store old positions for transition.
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // --- DATA PROCESSING & HELPERS --- //

        /**
         * Flattens the hierarchical data into an array of all nodes.
         */
        function processData() {
            state.allNodes = state.rootNode.descendants();
        }

        /**
         * Gets a descriptive level name based on code length.
         * @param {string} code - The occupation code.
         * @returns {string} The level name.
         */
        function getOccupationLevel(code) {
            const levels = { 1: 'División', 2: 'Grupo Principal', 3: 'Subgrupo', 4: 'Grupo Unitario' };
            return levels[String(code).length] || 'Ocupación';
        }

        /**
         * Gets a CSS class based on salary amount.
         * @param {number} salary - The average salary.
         * @returns {string} The CSS class name.
         */
        function getSalaryClass(salary) {
            if (!salary) return 'salary-low';
            if (salary >= 20000) return 'salary-high';
            if (salary >= 10000) return 'salary-medium';
            return 'salary-low';
        }
        
        /**
         * A utility to delay function execution, useful for resize events.
         * @param {function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {function} The debounced function.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- RENDERING LOGIC --- //
        
        /**
         * Updates the main statistics in the header.
         */
        function updateStats() {
            const leafNodes = state.allNodes.filter(d => !d.children && !d._children);
            const totalEmployees = d3.sum(leafNodes, d => d.data.employees || 0);
            const weightedSalarySum = d3.sum(leafNodes, d => (d.data.avgSalary || 0) * (d.data.employees || 0));
            
            DOM.statTotalOccupations.textContent = leafNodes.length.toLocaleString();
            DOM.statDivisions.textContent = state.rootNode.children.length;
            DOM.statTotalEmployees.textContent = totalEmployees.toLocaleString();
            DOM.statAvgSalary.textContent = `$${(totalEmployees > 0 ? Math.round(weightedSalarySum / totalEmployees) : 0).toLocaleString()} MXN`;
        }

        /**
         * Populates the table view with all occupation data.
         */
        function populateTable() {
            const sortedNodes = [...state.allNodes].sort((a, b) => a.data.code.localeCompare(b.data.code));
            const fragment = document.createDocumentFragment();
            
            sortedNodes.forEach(node => {
                if (node.depth === 0) return; // Skip root
                const item = node.data;
                const row = document.createElement('tr');
                row.dataset.code = item.code;
                row.innerHTML = `
                    <td>${item.code}</td>
                    <td title="${node.ancestors().map(d => d.data.name).reverse().join(' > ')}">${item.name}</td>
                    <td>${node.parent ? node.parent.data.name.split(':').pop().trim() : 'N/A'}</td>
                    <td><span class="salary-badge ${getSalaryClass(item.avgSalary)}">${item.avgSalary?.toLocaleString() || 'N/A'} MXN</span></td>
                    <td>${item.formality || 'N/A'}%</td>
                    <td>${item.employees?.toLocaleString() || 'N/A'}</td>
                `;
                fragment.appendChild(row);
            });
            DOM.tableBody.innerHTML = '';
            DOM.tableBody.appendChild(fragment);
        }
        
        /**
         * Populates the cards view with division-level data.
         */
        function populateCards() {
            const divisions = state.rootNode.children;
            const fragment = document.createDocumentFragment();

            divisions.forEach(division => {
                const card = document.createElement('div');
                card.className = 'division-card';
                card.dataset.code = division.data.code;
                
                const descendants = division.descendants();
                const leafNodes = descendants.filter(d => !d.children && !d._children);
                const totalEmployees = d3.sum(leafNodes, d => d.data.employees || 0);

                card.innerHTML = `
                    <div class="division-header">
                        <div class="division-title">${division.data.name}</div>
                        <div class="occupation-count">${leafNodes.length} ocupaciones</div>
                    </div>
                    <p><strong>Salario Promedio:</strong> ${division.data.avgSalary?.toLocaleString() || 'N/A'} MXN</p>
                    <p><strong>Total Empleados:</strong> ${totalEmployees.toLocaleString()}</p>
                    <p><strong>Formalidad Promedio:</strong> ${division.data.formality || 'N/A'}%</p>
                `;
                fragment.appendChild(card);
            });
            DOM.cardsView.innerHTML = '';
            DOM.cardsView.appendChild(fragment);
        }


        // --- EVENT HANDLERS --- //

        /**
         * Handles clicks on view toggle buttons to switch between visualizations.
         * @param {Event} e - The click event.
         */
        function handleViewSwitch(e) {
            const button = e.target.closest('.view-btn');
            if (!button) return;

            state.currentView = button.dataset.view;

            // Update button active state
            DOM.viewToggle.querySelector('.active').classList.remove('active');
            button.classList.add('active');

            // Toggle view visibility
            [DOM.treeView, DOM.tableView, DOM.cardsView].forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${state.currentView}View`).classList.remove('hidden');
            
            // Populate views if they haven't been already
            if (state.currentView === 'table' && DOM.tableBody.childElementCount === 0) {
                populateTable();
            } else if (state.currentView === 'cards' && DOM.cardsView.childElementCount === 0) {
                populateCards();
            }
            
            handleSearch(); // Re-apply search filter on view switch
        }
        
        /**
         * Toggles node children visibility on click.
         * @param {Event} event - The D3 click event.
         * @param {object} d - The clicked D3 node.
         */
        function handleNodeClick(event, d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            updateTree(d);
        }

        /**
         * Handles the search input to filter views.
         */
        function handleSearch() {
            const searchTerm = DOM.searchInput.value.toLowerCase().trim();
            
            // Clear previous highlights
            d3.selectAll('.node.search-highlight').classed('search-highlight', false);

            if (state.currentView === 'table') {
                DOM.tableBody.querySelectorAll('tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (state.currentView === 'cards') {
                DOM.cardsView.querySelectorAll('.division-card').forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            } else if (state.currentView === 'tree' && searchTerm) {
                const matchingNodes = state.allNodes.filter(node => 
                    node.data.name.toLowerCase().includes(searchTerm) ||
                    node.data.code.toLowerCase().includes(searchTerm)
                );
                
                if (matchingNodes.length > 0) {
                    // Expand path to the first found node and highlight it
                    expandPathToNode(matchingNodes[0]);
                    centerNode(matchingNodes[0]);
                    
                    // Highlight all matching nodes
                    matchingNodes.forEach(node => {
                        d3.selectAll("g.node").filter(d => d.id === node.id)
                            .classed('search-highlight', true);
                    });
                }
            }
        }
        
        /**
         * Expands the tree to make a target node visible.
         * @param {object} node - The D3 node to reveal.
         */
        function expandPathToNode(node) {
            node.ancestors().forEach(ancestor => {
                if (ancestor._children) {
                    ancestor.children = ancestor._children;
                    ancestor._children = null;
                }
            });
            updateTree(node);
        }

        /**
         * Centers the view on a specific node.
         * @param {object} node - The D3 node to center on.
         */
        function centerNode(node) {
            const width = DOM.treeView.clientWidth;
            const height = DOM.treeView.clientHeight;
            const transform = d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(1)
                .translate(-node.y, -node.x);
            
            state.d3.svg.transition().duration(750).call(state.d3.zoom.transform, transform);
        }

        /**
         * Handles resizing of the window to keep the visualization adaptive.
         */
        function handleResize() {
            if (state.currentView !== 'tree') return;

            const container = DOM.treeView;
            const width = container.clientWidth;
            const height = container.clientHeight;

            state.d3.svg.attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`);
            state.d3.treeLayout.size([height, width - 200]);
            updateTree(state.rootNode);
        }

        // --- Tooltip Handlers --- //
        function handleMouseOver(event, d) {
            DOM.tooltip.style.opacity = 1;
            DOM.tooltip.innerHTML = `
                <h3>${d.data.name}</h3>
                <p><strong>Código:</strong> ${d.data.code}</p>
                <p><strong>Nivel:</strong> ${getOccupationLevel(d.data.code)}</p>
                <p><strong>Salario Promedio:</strong> ${d.data.avgSalary?.toLocaleString() || 'N/A'} MXN</p>
                <p><strong>Formalidad:</strong> ${d.data.formality || 'N/A'}%</p>
                <p><strong>Empleados:</strong> ${d.data.employees?.toLocaleString() || 'N/A'}</p>
            `;
            d3.select(this).classed('highlight', true);
            d3.select(this).selectAll('path.link').classed('highlight', true);
        }

        function handleMouseMove(event) {
            const [x, y] = [event.pageX, event.pageY];
            DOM.tooltip.style.left = `${x + 15}px`;
            DOM.tooltip.style.top = `${y + 15}px`;
        }

        function handleMouseOut(event, d) {
            DOM.tooltip.style.opacity = 0;
            d3.select(this).classed('highlight', false);
        }

        // --- INITIALIZATION --- //
        function init() {
            // Show loader
            DOM.loader.classList.remove('hidden');

            // Process data after a short delay to allow the loader to render
            setTimeout(() => {
                initializeTreeView();
                processData();
                updateStats();

                // Setup event listeners
                DOM.searchInput.addEventListener('input', handleSearch);
                DOM.viewToggle.addEventListener('click', handleViewSwitch);
                window.addEventListener('resize', debounce(handleResize, 250));
                
                // Hide loader
                DOM.loader.classList.add('hidden');
            }, 50);
        }

        // Start the application once the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', init);

    })();
    </script>
</body>
</html>
